apiVersion: v1
kind: Service
# A service allows to expose the pods ports for Ingress/Egress
metadata:
  name: weaveplaceholder-rpc
spec:
  ports:
  - port: 26657
    name: rpc
    targetPort: 26657
  selector:
    app: weaveplaceholder
  type: NodePort
---
# A NodePort service allows to expose the pods ports to the outside world via an IP
apiVersion: v1
kind: Service
metadata:
  name: weaveplaceholder-p2p
spec:
  ports:
  - port: 26656
    name: p2p
    targetPort: 26656
  selector:
    app: weaveplaceholder
  type: NodePort
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: weaveplaceholder
spec:
  serviceName: weaveplaceholder  
  replicas: 1
  selector:
    matchLabels:
      app: weaveplaceholder
  updateStrategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: weaveplaceholder
    spec:
      terminationGracePeriodSeconds: 10
      initContainers:
      - args:
        - |
          set -exo pipefail
          if [ ! -f ${TMHOME}/.INITIALISED ]; then
           mkdir -p /data/bns
           mkdir -p ${TMHOME}/tmp
           tendermint init

           cp -f /etc/tendermint/genesis.json ${TMHOME}/config/genesis.json
           cat ${TMHOME}/config/genesis.json > ${TMHOME}/config/genesis.json_work

           # generate new key and add to genesis and local prival signer
           tendermint gen_validator > ${TMHOME}/config/priv_validator_work.json
           cat ${TMHOME}/config/priv_validator_work.json | jq ".Key" > ${TMHOME}/config/priv_validator_key.json
           cat ${TMHOME}/config/priv_validator_work.json | jq ".LastSignState" > ${TMHOME}/data/priv_validator_state.json
           cat ${TMHOME}/config/priv_validator_key.json | jq ".pub_key" | jq ". as \$k | {pub_key: \$k, power: \"10\", name: \"validator\"}" > ${TMHOME}/tmp/pub_validator.json
           cat ${TMHOME}/config/genesis.json_work | jq ".validators |= .+ [$(cat ${TMHOME}/tmp/pub_validator.json)]" > ${TMHOME}/config/genesis.json

           rm -rf ${TMHOME}/tmp
           rm -f  ${TMHOME}/config/genesis.json_work
           chmod 444 ${TMHOME}/config/genesis.json

           touch ${TMHOME}/.INITIALISED
          fi
          rm -f /socks/app.sock
        command:
        - bash
        - -c
        env:
        - name: TMHOME
          value: /data/tendermint
        image: iov1/tendermint:v0.31.5
        imagePullPolicy: Always
        name: tm-gen-validator
        resources:
          limits:
            cpu: 150m
            memory: 150Mi
          requests:
            cpu: 100m
            memory: 100Mi
        volumeMounts:
        - mountPath: /data
          name: tmdir
        - mountPath: /etc/tendermint/genesis.json
          name: tm-initialization
          readOnly: true
          subPath: genesis.json
        - mountPath: /socks
          name: socksdir
      - args:
        - -home=/data/tendermint
        - init
        - -i
        command: null
        image: iov1/bnsd:v0.21.0
        imagePullPolicy: Always
        name: weaveplaceholder-init
        resources:
          limits:
            cpu: 150m
            memory: 150Mi
          requests:
            cpu: 100m
            memory: 100Mi
        volumeMounts:
        - mountPath: /data
          name: tmdir
      containers:
      - name: tendermint
        imagePullPolicy: Always
        image: iov1/tendermint:v0.31.5
        ports:
        - containerPort: 26656
          name: p2p
        - containerPort: 26657
          name: rpc
        env:
        - name: TMHOME
          value: /data/tendermint
        command:
        - bash
        - "-c"
        - |
          set -exo pipefail
          
          # wait for weaveplaceholder to get started
          while [ ! -S /socks/app.sock ]; do
            sleep 1
          done
          
          exec tendermint node \
            --moniker="`hostname`" \
            --log_level="p2p:info,state:info,*:error" \
            --proxy_app="unix:///socks/app.sock"
        volumeMounts:
        - name: tmdir
          mountPath: /data/tendermint
          subPath: tendermint
        - mountPath: /data/tendermint/config/config.toml
          name: tm-configuration
          subPath: config.toml
          readOnly: true
        - name: socksdir
          mountPath: /socks
        - name: tm-rw-volume
          mountPath: /tmp
        readinessProbe:
          exec:
            command:
              - sh
              - -o
              - pipefail
              - -ec
              - 'curl -s --fail http://localhost:26657/abci_info | jq --exit-status ".result.response"'
          failureThreshold: 999999
          periodSeconds: 20
          initialDelaySeconds: 40
        livenessProbe:
          exec:
            command:
            - sh
            - -o
            - pipefail
            - -ec
            - 'curl -s --fail http://localhost:26657/abci_info | jq --exit-status ".result.response"'
          failureThreshold: 3
          initialDelaySeconds: 40
          periodSeconds: 5
          successThreshold: 1
          timeoutSeconds: 2
      - name: weaveplaceholder
        imagePullPolicy: Always
        image: iov1/bnsd:v0.21.0
        args:
          - '-home=/data/weaveplaceholder'
          - start
          - '-bind=unix:///socks/app.sock'
        volumeMounts:
        - name: socksdir
          mountPath: /socks
        - name: tmdir
          mountPath: /data/bns
          subPath: bns
      volumes:
      - name: tm-initialization
        configMap:
          name: validator-genesis
      - name: tm-configuration
        configMap:
          name: validator-config
      - name: socksdir
        emptyDir: {}
      - name: tm-rw-volume
        emptyDir: {}
  volumeClaimTemplates:
  - metadata:
      name: tmdir
    spec:
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: 1Gi
